<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foraging Chart</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f4f1eb; color: #2d2a24; padding: 1.5rem; }
    h1 { font-size: 1.6rem; margin-bottom: .4rem; color: #3a5a28; }
    .subtitle { color: #6b6b6b; margin-bottom: 1.2rem; font-size: .9rem; }
    /* toolbar */
    .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .toolbar button, .toolbar select {
      padding: .45rem .9rem; border: 1px solid #b5c4a8; border-radius: 6px;
      background: #fff; cursor: pointer; font-size: .85rem; color: #2d2a24;
    }
    .toolbar button:hover { background: #e8f0e0; }
    .toolbar .btn-primary { background: #4a7c34; color: #fff; border-color: #4a7c34; }
    .toolbar .btn-primary:hover { background: #3a5a28; }
    /* filter */
    #seasonFilter { min-width: 130px; }
    /* table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    th, td { padding: .6rem .75rem; text-align: left; border-bottom: 1px solid #e8e5df; font-size: .85rem; }
    th { background: #4a7c34; color: #fff; font-weight: 600; position: sticky; top: 0; }
    tr:hover td { background: #f9f7f3; }
    .badge { display: inline-block; padding: .15rem .5rem; border-radius: 10px; font-size: .75rem; font-weight: 600; }
    .badge-in { background: #d4edda; color: #1b5e20; }
    .badge-soon { background: #fff3cd; color: #856404; }
    .badge-out { background: #f5d5d5; color: #8b1a1a; }
    .actions button { background: none; border: none; cursor: pointer; font-size: .95rem; padding: .15rem .35rem; border-radius: 4px; }
    .actions button:hover { background: #eee; }
    /* modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .modal-overlay.hidden { display: none; }
    .modal { background: #fff; border-radius: 10px; padding: 1.5rem; width: 95%; max-width: 480px; box-shadow: 0 8px 30px rgba(0,0,0,.18); }
    .modal h2 { font-size: 1.15rem; margin-bottom: 1rem; color: #3a5a28; }
    .modal label { display: block; font-size: .8rem; font-weight: 600; margin-bottom: .2rem; margin-top: .7rem; }
    .modal input, .modal select, .modal textarea {
      width: 100%; padding: .4rem .6rem; border: 1px solid #ccc; border-radius: 6px; font-size: .85rem;
    }
    .modal textarea { resize: vertical; min-height: 50px; }
    .modal-actions { display: flex; gap: .5rem; justify-content: flex-end; margin-top: 1.2rem; }
    .modal-actions button { padding: .45rem 1rem; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; font-size: .85rem; }
    .modal-actions .btn-save { background: #4a7c34; color: #fff; border-color: #4a7c34; }
    .empty-state { text-align: center; padding: 2.5rem 1rem; color: #999; font-size: .95rem; }
    .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; cursor: pointer; }
    .img-preview { max-width: 100%; max-height: 120px; border-radius: 6px; margin-top: .3rem; }
    .img-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; align-items: center; justify-content: center; z-index: 200; cursor: pointer; }
    .img-modal-overlay img { max-width: 90%; max-height: 90%; border-radius: 8px; }

    /* Mobile card layout */
    .cards { display: none; }
    @media (max-width: 640px) {
      body { padding: .75rem; }
      h1 { font-size: 1.3rem; }
      .toolbar { gap: .35rem; }
      .toolbar button, .toolbar select { padding: .4rem .6rem; font-size: .8rem; }
      .table-wrap { display: none; }
      .cards { display: flex; flex-direction: column; gap: .75rem; }
      .card {
        background: #fff; border-radius: 10px; padding: .85rem;
        box-shadow: 0 1px 4px rgba(0,0,0,.08); display: flex; gap: .75rem;
      }
      .card-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; flex-shrink: 0; cursor: pointer; }
      .card-img-placeholder { width: 64px; height: 64px; border-radius: 8px; background: #eee; display: flex; align-items: center; justify-content: center; color: #bbb; font-size: 1.4rem; flex-shrink: 0; }
      .card-body { flex: 1; min-width: 0; }
      .card-name { font-weight: 600; font-size: .95rem; color: #3a5a28; }
      .card-meta { font-size: .78rem; color: #666; margin-top: .2rem; line-height: 1.4; }
      .card-actions { display: flex; gap: .3rem; margin-top: .4rem; }
      .card-actions button { background: none; border: 1px solid #ddd; border-radius: 6px; padding: .25rem .5rem; cursor: pointer; font-size: .85rem; }
      .card-actions button:hover { background: #f0f0f0; }
      .modal { padding: 1.1rem; width: 98%; }
      .modal h2 { font-size: 1.05rem; }
    }
  </style>
</head>
<body>

<h1>üåø Foraging Chart</h1>
<p class="subtitle">Track what to forage, when to pick it, and when to use it.</p>

<div class="toolbar">
  <button class="btn-primary" onclick="openModal()" aria-label="Add new item">+ Add Item</button>
  <button onclick="exportCSV()" aria-label="Export to CSV">üìÑ Export CSV</button>
  <button onclick="saveBackup()" aria-label="Save backup">üíæ Save Backup</button>
  <button onclick="document.getElementById('loadBackupInput').click()" aria-label="Load backup">üìÇ Load Backup</button>
  <input type="file" id="loadBackupInput" accept=".json" style="display:none" onchange="loadBackup(event)">
  <select id="seasonFilter" onchange="renderTable()" aria-label="Filter by season">
    <option value="">All Seasons</option>
    <option value="Spring">Spring</option>
    <option value="Summer">Summer</option>
    <option value="Fall">Fall</option>
    <option value="Winter">Winter</option>
    <option value="Year-round">Year-round</option>
  </select>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Photo</th><th>Name</th><th>Category</th><th>Forage Season</th>
        <th>Forage Window</th><th>Use-By Window</th><th>Status</th>
        <th>Notes</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
<div class="cards" id="cardContainer"></div>

<!-- Add / Edit Modal -->
<div class="modal-overlay hidden" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle">Add Forageable</h2>
    <label for="fName">Name</label>
    <input id="fName" placeholder="e.g. Chanterelle Mushroom">
    <label for="fCategory">Category</label>
    <select id="fCategory">
      <option>Mushroom</option><option>Flower</option><option>Berry</option>
      <option>Herb</option><option>Nut</option><option>Green</option><option>Root</option><option>Other</option>
    </select>
    <label for="fSeason">Forage Season</label>
    <select id="fSeason">
      <option>Spring</option><option>Summer</option><option>Fall</option><option>Winter</option><option>Year-round</option>
    </select>
    <label for="fStart">Forage Window Start</label>
    <input id="fStart" type="date">
    <label for="fEnd">Forage Window End</label>
    <input id="fEnd" type="date">
    <label for="fUseBy">Use-By (days after harvest)</label>
    <input id="fUseBy" type="number" min="0" value="7" placeholder="Days">
    <label for="fImage">Photo</label>
    <input id="fImage" type="file" accept="image/*">
    <div id="fImagePreview" style="margin-top:.4rem;"></div>
    <label for="fNotes">Notes</label>
    <textarea id="fNotes" placeholder="Habitat, preparation tips, etc."></textarea>
    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveItem()">Save</button>
    </div>
  </div>
</div>

<script>

const STORAGE_KEY = 'foraging_chart';
let items = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let editingId = null;
let pendingImage = null;

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }

function getStatus(item) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const start = new Date(item.forageStart + 'T00:00:00');
  const end = new Date(item.forageEnd + 'T00:00:00');
  const soon = new Date(start); soon.setDate(soon.getDate() - 14);
  if (today >= start && today <= end) return 'In Season';
  if (today >= soon && today < start) return 'Coming Soon';
  return 'Out of Season';
}

function statusBadge(status) {
  const cls = status === 'In Season' ? 'badge-in' : status === 'Coming Soon' ? 'badge-soon' : 'badge-out';
  return `<span class="badge ${cls}">${status}</span>`;
}

function renderTable() {
  const filter = document.getElementById('seasonFilter').value;
  const tbody = document.getElementById('tableBody');
  let filtered = filter ? items.filter(i => i.season === filter) : [...items];

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="empty-state">${items.length ? 'No items match this filter.' : 'No items yet ‚Äî click "+ Add Item" to start tracking.'}</td></tr>`;
    document.getElementById('cardContainer').innerHTML = `<div class="empty-state">${items.length ? 'No items match this filter.' : 'No items yet ‚Äî tap "+ Add Item" to start tracking.'}</div>`;
    return;
  }

  tbody.innerHTML = filtered.map(item => {
    const status = getStatus(item);
    return `<tr>
      <td>${item.image ? `<img src="${item.image}" class="thumb" alt="${esc(item.name)}" onclick="viewImage('${item.id}')">` : '‚Äî'}</td>
      <td>${esc(item.name)}</td>
      <td>${esc(item.category)}</td>
      <td>${esc(item.season)}</td>
      <td>${item.forageStart} ‚Üí ${item.forageEnd}</td>
      <td>${item.useByDays} days</td>
      <td>${statusBadge(status)}</td>
      <td>${esc(item.notes || '‚Äî')}</td>
      <td class="actions">
        <button onclick="editItem('${item.id}')" title="Edit" aria-label="Edit ${esc(item.name)}">‚úèÔ∏è</button>
        <button onclick="deleteItem('${item.id}')" title="Delete" aria-label="Delete ${esc(item.name)}">üóëÔ∏è</button>
        <button onclick="addToGCal('${item.id}')" title="Add to Google Calendar" aria-label="Add ${esc(item.name)} to Google Calendar">üìÖ</button>
      </td>
    </tr>`;
  }).join('');

  // Render mobile cards
  const cardContainer = document.getElementById('cardContainer');
  cardContainer.innerHTML = filtered.map(item => {
    const status = getStatus(item);
    const imgHtml = item.image
      ? `<img src="${item.image}" class="card-img" alt="${esc(item.name)}" onclick="viewImage('${item.id}')">`
      : `<div class="card-img-placeholder">üåø</div>`;
    return `<div class="card">
      ${imgHtml}
      <div class="card-body">
        <div class="card-name">${esc(item.name)} ${statusBadge(status)}</div>
        <div class="card-meta">
          ${esc(item.category)} ¬∑ ${esc(item.season)}<br>
          üìÖ ${item.forageStart} ‚Üí ${item.forageEnd}<br>
          ‚è≥ Use within ${item.useByDays} days
          ${item.notes ? `<br>üìù ${esc(item.notes)}` : ''}
        </div>
        <div class="card-actions">
          <button onclick="editItem('${item.id}')" aria-label="Edit ${esc(item.name)}">‚úèÔ∏è</button>
          <button onclick="deleteItem('${item.id}')" aria-label="Delete ${esc(item.name)}">üóëÔ∏è</button>
          <button onclick="addToGCal('${item.id}')" aria-label="Add to calendar">üìÖ</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function esc(s) {
  const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
}

function openModal(id) {
  editingId = id || null;
  document.getElementById('modalTitle').textContent = id ? 'Edit Forageable' : 'Add Forageable';
  if (id) {
    const item = items.find(i => i.id === id);
    document.getElementById('fName').value = item.name;
    document.getElementById('fCategory').value = item.category;
    document.getElementById('fSeason').value = item.season;
    document.getElementById('fStart').value = item.forageStart;
    document.getElementById('fEnd').value = item.forageEnd;
    document.getElementById('fUseBy').value = item.useByDays;
    document.getElementById('fNotes').value = item.notes;
    document.getElementById('fImagePreview').innerHTML = item.image ? `<img src="${item.image}" class="img-preview" alt="Preview">` : '';
    pendingImage = item.image || null;
  } else {
    ['fName','fNotes'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('fUseBy').value = 7;
    document.getElementById('fStart').value = '';
    document.getElementById('fEnd').value = '';
    document.getElementById('fImage').value = '';
    document.getElementById('fImagePreview').innerHTML = '';
    pendingImage = null;
  }
  document.getElementById('modalOverlay').classList.remove('hidden');
  document.getElementById('fName').focus();
}

// Handle image file selection
document.getElementById('fImage').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    // Resize to keep localStorage manageable
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxDim = 400;
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        if (w > h) { h = h * maxDim / w; w = maxDim; }
        else { w = w * maxDim / h; h = maxDim; }
      }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      pendingImage = canvas.toDataURL('image/jpeg', 0.7);
      document.getElementById('fImagePreview').innerHTML = `<img src="${pendingImage}" class="img-preview" alt="Preview">`;
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

function viewImage(id) {
  const item = items.find(i => i.id === id);
  if (!item || !item.image) return;
  const overlay = document.createElement('div');
  overlay.className = 'img-modal-overlay';
  overlay.innerHTML = `<img src="${item.image}" alt="${item.name}">`;
  overlay.onclick = () => overlay.remove();
  document.body.appendChild(overlay);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.add('hidden');
  editingId = null;
}

function saveItem() {
  const name = document.getElementById('fName').value.trim();
  const forageStart = document.getElementById('fStart').value;
  const forageEnd = document.getElementById('fEnd').value;
  if (!name || !forageStart || !forageEnd) { alert('Name and forage window dates are required.'); return; }

  const data = {
    name,
    category: document.getElementById('fCategory').value,
    season: document.getElementById('fSeason').value,
    forageStart,
    forageEnd,
    useByDays: parseInt(document.getElementById('fUseBy').value) || 7,
    notes: document.getElementById('fNotes').value.trim(),
    image: pendingImage || null,
  };

  if (editingId) {
    const idx = items.findIndex(i => i.id === editingId);
    items[idx] = { ...items[idx], ...data };
  } else {
    data.id = crypto.randomUUID();
    items.push(data);
  }
  save(); renderTable(); closeModal();
}

function editItem(id) { openModal(id); }

function deleteItem(id) {
  if (!confirm('Delete this item?')) return;
  items = items.filter(i => i.id !== id);
  save(); renderTable();
}

// Google Calendar link ‚Äî no API key needed, just opens a pre-filled event creation URL
function addToGCal(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  const title = encodeURIComponent(`üåø Forage: ${item.name}`);
  const startDate = item.forageStart.replace(/-/g, '');
  // end date for all-day events in gcal needs to be the day AFTER
  const endParts = item.forageEnd.split('-').map(Number);
  const endD = new Date(endParts[0], endParts[1]-1, endParts[2]+1);
  const endDate = endD.toISOString().slice(0,10).replace(/-/g, '');
  const details = encodeURIComponent(
    `Category: ${item.category}\nSeason: ${item.season}\nUse within ${item.useByDays} days of harvest.\n${item.notes ? 'Notes: ' + item.notes : ''}`
  );
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${details}`;
  window.open(url, '_blank', 'noopener');
}

// Backup save ‚Äî downloads all data as a JSON file
function saveBackup() {
  if (!items.length) { alert('Nothing to back up.'); return; }
  const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'foraging_backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

// Backup load ‚Äî restores data from a JSON file
function loadBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) { alert('Invalid backup file.'); return; }
      if (items.length && !confirm('This will replace all your current data. Continue?')) return;
      items = data;
      save();
      renderTable();
      alert('Backup restored successfully!');
    } catch { alert('Could not read backup file. Make sure it\'s a valid .json file.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// CSV export
function exportCSV() {
  if (!items.length) { alert('Nothing to export.'); return; }
  const headers = ['Name','Category','Season','Forage Start','Forage End','Use-By Days','Notes'];
  const rows = items.map(i => [i.name, i.category, i.season, i.forageStart, i.forageEnd, i.useByDays, i.notes].map(v => `"${String(v).replace(/"/g,'""')}"`));
  const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'foraging_chart.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// Seed some example data if empty
if (!items.length) {
  items = [
    { id: crypto.randomUUID(), name: 'Chanterelle', category: 'Mushroom', season: 'Summer', forageStart: '2026-06-15', forageEnd: '2026-09-30', useByDays: 5, notes: 'Found near oak and conifer trees. Saut√© in butter.' },
    { id: crypto.randomUUID(), name: 'Ramps (Wild Leek)', category: 'Green', season: 'Spring', forageStart: '2026-03-15', forageEnd: '2026-05-15', useByDays: 7, notes: 'Appalachian forests. Use leaves and bulbs.' },
    { id: crypto.randomUUID(), name: 'Elderflower', category: 'Flower', season: 'Spring', forageStart: '2026-05-01', forageEnd: '2026-06-30', useByDays: 3, notes: 'Great for cordials and fritters. Dry for tea.' },
    { id: crypto.randomUUID(), name: 'Wild Blackberry', category: 'Berry', season: 'Summer', forageStart: '2026-07-01', forageEnd: '2026-08-31', useByDays: 4, notes: 'Hedgerows and woodland edges.' },
    { id: crypto.randomUUID(), name: 'Daylily', category: 'Flower', season: 'Summer', forageStart: '2026-06-01', forageEnd: '2026-08-15', useByDays: 2, notes: 'Buds and flowers are edible. Avoid lookalikes.' },
  ];
  save();
}

// Close modal on overlay click or Escape
document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

renderTable();
</script>
</body>
</html>
